# Errors and Fixes - Pique Unique

*Generated by Claude 3.5 Sonnet - Sprint 0 Analysis*

## Critical Security Issues

### 1. Missing Firebase Storage Rules
**Issue**: No `storage.rules` file found - Firebase Storage is completely open
**Risk**: HIGH - Unauthorized file uploads/downloads possible
**Fix**: Create `storage.rules` with authentication-only access

```javascript
// storage.rules
rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    // Only authenticated users can upload
    match /{allPaths=**} {
      allow read, write: if request.auth != null;
    }
    
    // Admin-only for sensitive uploads
    match /admin/{allPaths=**} {
      allow read, write: if request.auth != null && 
        firestore.get(/databases/(default)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }
  }
}
```

### 2. Open Firestore Reads
**Issue**: `themes` and `reviews` collections allow unrestricted read access
**Risk**: MEDIUM - Potential data exposure
**Current Rules**:
```javascript
// themes collection
allow read: if true;  // ← TOO OPEN

// reviews collection  
allow read: if true;  // ← TOO OPEN
```

**Fix**: Restrict if sensitive data exists
```javascript
// If themes contain pricing/sensitive info:
allow read: if request.auth != null;

// If reviews need moderation:
allow read: if request.auth != null || resource.data.status == 'approved';
```

## Code Quality Issues

### 3. No Test Coverage
**Issue**: Zero test files found in project
**Risk**: MEDIUM - No regression protection
**Fix**: Add Jest setup with critical test stubs

```javascript
// __tests__/lib/auth.test.ts
import { useAuth } from '@/lib/auth';

describe('Auth Module', () => {
  test('should handle sign in errors gracefully', () => {
    // Test error handling from auth.ts
  });
  
  test('should validate admin permissions', () => {
    // Test isAdmin logic
  });
});
```

### 4. Error Handling Patterns
**Found**: 200+ console.error statements across codebase
**Issues**:
- Inconsistent error messages (mix of Lithuanian/English)
- No centralized error logging
- Missing user-friendly error boundaries

**Fix**: Implement centralized error handling
```typescript
// lib/error-handler.ts
export class AppError extends Error {
  constructor(
    message: string,
    public code: string,
    public statusCode: number = 500
  ) {
    super(message);
  }
}

export const handleApiError = (error: unknown) => {
  if (error instanceof AppError) {
    return NextResponse.json(
      { error: error.message, code: error.code },
      { status: error.statusCode }
    );
  }
  // Log to monitoring service
  console.error('Unexpected error:', error);
  return NextResponse.json(
    { error: 'Vidinė serverio klaida' },
    { status: 500 }
  );
};
```

## Performance Issues

### 5. Missing Image Optimization
**Issue**: Gallery page uses dynamic imports but no Next.js Image optimization
**Current**: `<img>` tags in GalleryContent component
**Fix**: Replace with Next.js Image component

```typescript
// components/GalleryContent.tsx
import Image from 'next/image';

// Replace <img> with:
<Image
  src={imageUrl}
  alt={altText}
  width={400}
  height={300}
  className="rounded-lg"
  loading="lazy"
  placeholder="blur"
/>
```

### 6. No SEO Metadata on Services Page
**Issue**: Gallery redirects to `/services` but no services page exists
**Current**: Gallery page has good metadata, but redirect target missing
**Fix**: Create `/app/services/page.tsx` with proper SEO

```typescript
// app/services/page.tsx
export const metadata: Metadata = {
  title: 'Pikniko Paslaugos - Pique Unique',
  description: 'Profesionalios pikniko paslaugos Klaipėdoje su temomis ir papildomomis paslaugomis',
  openGraph: {
    title: 'Pikniko Paslaugos - Pique Unique',
    description: 'Profesionalios pikniko paslaugos su ACALA, MAAR ir kitomis paslaugomis',
  },
};
```

## Validation Issues

### 7. Weak API Validation
**Issue**: `/api/bookings` has basic validation but no Zod schema
**Current**: Manual field checking
**Fix**: Add Zod validation

```typescript
// lib/validation/booking.ts
import { z } from 'zod';

export const bookingSchema = z.object({
  location: z.enum(['juodkrante', 'nida', 'klaipeda']),
  date: z.string().datetime(),
  theme: z.enum(['undiniu', 'feju', 'laumiu', 'disco']),
  time: z.string().regex(/^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/),
  guestCount: z.number().min(1).max(20),
  contactInfo: z.object({
    name: z.string().min(2),
    email: z.string().email(),
    phone: z.string().min(8),
  }),
});

// In api/bookings/route.ts
const validatedData = bookingSchema.parse(body);
```

## Missing Features

### 8. No Email/ICS Integration
**Issue**: Email sending disabled, no calendar integration
**Current**: `RESEND_API_KEY` not configured
**Fix**: Add email stubs and ICS generation

```typescript
// lib/email/ics-generator.ts
export const generateICS = (booking: Booking) => {
  const ics = [
    'BEGIN:VCALENDAR',
    'VERSION:2.0',
    'PRODID:-//Pique Unique//Booking//EN',
    'BEGIN:VEVENT',
    `UID:${booking.id}@pique-unique.lt`,
    `DTSTART:${formatDate(booking.date)}T${booking.time}:00`,
    `DTEND:${formatDate(booking.date)}T${addHours(booking.time, 3)}:00`,
    `SUMMARY:Pikniko rezervacija - ${booking.theme}`,
    `DESCRIPTION:Vieta: ${booking.location}, Svečiai: ${booking.guestCount}`,
    'END:VEVENT',
    'END:VCALENDAR'
  ].join('\r\n');
  
  return ics;
};
```

## Summary

**Critical (Fix Immediately)**:
1. Add Firebase Storage rules
2. Review Firestore security rules
3. Add basic test coverage

**High Priority**:
4. Implement centralized error handling
5. Add Zod validation to APIs
6. Create missing services page

**Medium Priority**:
7. Optimize images with Next.js Image
8. Add email/ICS integration stubs

**Total Issues Found**: 8 critical/high priority issues
**Estimated Fix Time**: 2-3 days for critical issues
